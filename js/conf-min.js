const DEFAULT_ROOM="5f1f2f794758efceeeeb90a8";var token=null,SPACES_TOKEN=null,socketURL="http://spacesapis-socket.avayacloud.com/chat",spaceId=DEFAULT_ROOM,connectionPayload={query:"token="+token+"&tokenType=jwt"},socketConnection="";let conferenceCall=null,conferenceType="",user=null;var client,collaborations,collaboration,remoteStream,localStream,mediaEngine,videoChannels,call,userName="Anonymous User",videoUnmuted=!0,audioUnmuted=!0,onScreenShare=!1,recording=!1,inCall=!1,recordingId=null,meetingId=null,password=null,attendeeId=null,peopleInMeeting=[],micDevices=["junk"],cameraDevices=["junk"],speakerDevices=["junk"];let contentSharingRenderer;function init(){checkQueryParameters(),confUI.setUp(),videoUnmuted=!0,audioUnmuted=!0,onScreenShare=!1,recording=!1,inCall=!1,initializeMicList(),initializeCameraList(),initializeSpeakersList()}function populateAudioDevices(){console.log("Populate Audio Devices"),displayMicDevices(),displayCameraDevices(),displaySpeakerDevices()}function displayMicDevices(){console.log("displayMicDevices");var e=client.getMediaServices().getAudioInterface().getInputInterface();$("#micList").find("option").remove(),initializeMicList(),e.getAvailableDevices().forEach((function(e){"default"!=e._deviceId&&"communications"!=e._deviceId&&(addMicrophone(e._label,e._deviceId),micDevices.push(e)),console.log(e)}))}function displayCameraDevices(){console.log("displayCameraDevices");var e=client.getMediaServices().getVideoInterface();$("#cameraList").find("option").remove(),initializeCameraList(),e.getAvailableDevices().forEach((function(e){"default"!=e._deviceId&&"communications"!=e._deviceId&&(addCamera(e._label,e._deviceId),cameraDevices.push(e),console.log(e))}))}function displaySpeakerDevices(){console.log("displaySpeakerDevices");var e=client.getMediaServices().getAudioInterface().getOutputInterface();$("#speakersList").find("option").remove(),initializeSpeakersList(),e.getAvailableDevices().forEach((function(e){"default"!=e._deviceId&&"communications"!=e._deviceId&&(addSpeaker(e._label,e._deviceId),speakerDevices.push(e)),console.log(e)}))}function setMicrophone(e){client.getMediaServices().getAudioInterface().getInputInterface().setSelectedDevice(e)}function setCamera(e){client.getMediaServices().getVideoInterface().setSelectedDevice(e)}function setSpeakers(e){client.getMediaServices().getAudioInterface().getOutputInterface().setSelectedDevice(e)}function addMicrophone(e,n){var o=document.getElementById("micList");o.options[o.length]=new Option(e,n)}function addCamera(e,n){var o=document.getElementById("cameraList");o.options[o.length]=new Option(e,n)}function addSpeaker(e,n){var o=document.getElementById("speakersList");o.options[o.length]=new Option(e,n)}function selectMic(){var e=document.getElementById("micList");console.log("Selected index "+e.selectedIndex),mic=e.options[e.selectedIndex].value,console.log("Mic "+mic),"DEFAULT"!=e.value&&setMicrophone(micDevices[e.selectedIndex])}function selectCamera(){var e=document.getElementById("cameraList");console.log("Selected index "+e.selectedIndex),camera=e.options[e.selectedIndex].value,console.log("Camera "+camera),"DEFAULT"!=e.value&&setCamera(cameraDevices[e.selectedIndex])}function selectSpeakers(){var e=document.getElementById("speakersList");console.log("Selected index "+e.selectedIndex),speaker=e.options[e.selectedIndex].value,console.log("Speaker "+speaker),"DEFAULT"!=e.value&&setSpeakers(speakerDevices[e.selectedIndex])}function initializeMicList(){micDevices=["junk"];var e=document.getElementById("micList");e.innerHTML="",e.options[0]=new Option("--Select--","DEFAULT")}function initializeCameraList(){cameraDevices=["junk"];var e=document.getElementById("cameraList");e.innerHTML="",e.options[0]=new Option("--Select--","DEFAULT")}function initializeSpeakersList(){speakerDevices=["junk"];var e=document.getElementById("speakersList");e.innerHTML="",e.options[0]=new Option("--Select--","DEFAULT")}function sendToDialogflow(e){var n={message:e};$.ajax({headers:{Accept:"application/json","Content-type":"application/json"},url:"https://ip-72-167-227-239.ip.secureserver.net:5000/dialogflow",type:"post",dataType:"json",contentType:"application/json",data:JSON.stringify(n),success:function(e){sendMessage(e.response)},error:function(e){console.log("Dialogflow error")}})}function chatSpace(){var e={content:{bodyText:$("#message").val()}};$.ajax({headers:{Authorization:"jwt "+token,Accept:"application/json","Content-type":"application/json","spaces-x-space-password":password},url:"https://spacesapis.avayacloud.com/api/spaces/"+spaceId+"/chats",type:"post",dataType:"json",contentType:"application/json",data:JSON.stringify(e),success:function(e){document.getElementById("message").value=""},error:function(e){console.log("Error "+e)}})}function deleteRoomAccessToken(){$.ajax({headers:{Accept:"application/json"},url:"https://ip-72-167-227-239.ip.secureserver.net:5000/getToken",type:"GET",success:function(e){SPACES_TOKEN=e.accessToken,deleteRoom(),console.log("Room Deleted")},error:function(e){console.log("Room Not Deleted"),console.log("Error "+e)}})}function deleteRoom(){$.ajax({headers:{Authorization:"Bearer "+SPACES_TOKEN,Accept:"application/json","spaces-x-space-password":password},url:"https://spacesapis.avayacloud.com/api/spaces/"+spaceId,type:"delete",success:function(e){console.log("Room Deleted")},error:function(e){console.log("Room Not Deleted"),console.log("Error "+e)}})}function trace(e){e=e.trim(),confUI.addToConsole(e)}function clearTrace(){$("#console-log").val();$("#console-log").val("")}function getMeetingIdAndRecord(){$.ajax({headers:{Authorization:"jwt "+token,Accept:"application/json","Content-type":"application/json","spaces-x-space-password":password},url:"https://spacesapis.avayacloud.com/api/spaces/"+spaceId+"/activemeeting",type:"GET",dataType:"json",success:function(e){meetingId=e._id,startRecordingFunction()},error:function(e){console.log("Get Meeting ID Error"),console.log("Error "+e)},complete:function(){}})}function startRecordingFunction(){$.ajax({headers:{Authorization:"jwt "+token,Accept:"application/json","Content-type":"application/json","spaces-x-space-password":password},url:"https://spacesapis.avayacloud.com/api/spaces/"+spaceId+"/meetings/"+meetingId+"/recordings",type:"POST",dataType:"json",contentType:"application/json",success:function(e){document.getElementById("startRecording").innerHTML='<img src="./images/end@2.png" />',recording=!0},error:function(e){console.log("Start Recording Error"),console.log("Error "+e)}})}function updateScreensharePresence(e){onScreenShare=e;let n={category:"app.event.presence.party.online",content:{desktop:!1,idle:!1,mediaSession:{audio:audioUnmuted,connected:!0,phone:!1,screenshare:e,selfMuted:!1,video:videoUnmuted},offline:!1,role:"guest"},topicId:spaceId};socketConnection.emit("SEND_PRESENCE_EVENT",n)}function startSreenshare(){0==onScreenShare?(onScreenShare=!0,confUI.startScreenShare(),collaboration.getContentSharing().startScreenSharing(),updateScreensharePresence(!0)):(updateScreensharePresence(!1),confUI.stopScreenShare(),collaboration.getContentSharing().end(),startLocalVideo2(localStream))}function startRecording(){recording?stopRecording():getMeetingIdAndRecord()}function stopRecording(){$.ajax({headers:{Authorization:"jwt "+token,Accept:"application/json","spaces-x-space-password":password},url:"https://spacesapis.avayacloud.com/api/spaces/"+spaceId+"/meetings/"+meetingId+"/recordings/"+recordingId+"/stop",type:"POST",dataType:"json",success:function(e){confUI.startRecording(),recording=!1},error:function(e){console.log("Error "+e),console.dir(e)}})}function openSpacesConference(){inCall?closeSpacesConference():null==token?getSpacesToken().then((function(){joinSpace()}),(function(){console.log("token failure")})):joinSpace()}function startVideoForSpaces(){var e=null;$.ajax("https://spacesapis.avayacloud.com/api/mediasessions/mpaas/token/"+spaceId,{type:"GET",headers:{Authorization:"jwt "+token,"spaces-x-space-password":password},success:n=>{if(e=n.token,socketConnection){const n={mediaServiceContext:e,callUserConfiguration:{videoEnabled:!0,incomingCall:!0,retrieveDeviceLabelsEnabled:!1},wcsConfiguration:{enabled:!0},collaborationConfiguration:{contentSharingWorkerPath:"./js/lib/AvayaClientServicesWorker.min.js"}};client=new AvayaClientServices,console.log("Client SDK Version = "+client.getVersion()),user=client.createUser(n),user.start().then((function(){initiateSpacesCall()}),(function(){console.log("user.start failure")}))}}})}function initiateSpacesCall(){(call=user.getCalls().createDefaultCall()).setVideoMode(AvayaClientServices.Services.Call.VideoMode.SEND_RECEIVE),call.setWebCollaboration(!0),call.addOnCallIncomingVideoAddRequestDeniedCallback((function(e){console.error("IncomingVideoAddRequestDenied")})),call.addOnCallFailedCallback((function(e,n){console.error("call failed",n)})),call.addOnCallEndedCallback((function(e,n){})),call.addOnCallEstablishingCallback((function(e){})),call.addOnCallVideoChannelsUpdatedCallback((function(e){var n=client.getMediaServices(),o=e.getVideoChannels();if(o[0])switch(o[0].getNegotiatedDirection()){case AvayaClientServices.Services.Call.MediaDirection.RECV_ONLY:AvayaClientServices.Base.Utils.isDefined(remoteStream)?startRemoteVideo(remoteStream):remoteStream=null;break;case AvayaClientServices.Services.Call.MediaDirection.SEND_ONLY:AvayaClientServices.Base.Utils.isDefined(localStream)?startLocalVideo2(localStream):localStream=null;break;case AvayaClientServices.Services.Call.MediaDirection.SEND_RECV:remoteStream=n.getVideoInterface().getRemoteMediaStream(o[0].getChannelId()),localStream=n.getVideoInterface().getLocalMediaStream(o[0].getChannelId()),AvayaClientServices.Base.Utils.isDefined(localStream)?startLocalVideo2(localStream):localStream=null,AvayaClientServices.Base.Utils.isDefined(remoteStream)?startRemoteVideo(remoteStream):remoteStream=null,confUI.readyToReceiveMedia();break;case AvayaClientServices.Services.Call.MediaDirection.INACTIVE:case AvayaClientServices.Services.Call.MediaDirection.DISABLE:}})),call.addOnCallConferenceStatusChangedCallback((function(e){collaboration.addOnCollaborationServiceAvailableCallback(()=>{collaboration.getContentSharing().addOnContentSharingStartedCallback(()=>{onScreenShare?(contentSharingRenderer=new AvayaClientServices.Renderer.Konva.KonvaContentSharingRenderer,document.querySelector("#localVideoElement").srcObject=collaboration.getContentSharing().getOutgoingScreenSharingStream(),document.querySelector("#littleVideoDisplay").srcObject=document.querySelector("#localVideoElement").srcObject,document.querySelector("#littleVideoDisplay2").srcObject=document.querySelector("#remoteVideoElement").srcObject):(confUI.contentSharingRendererZoom=1,confUI.minZoomValue=.25,contentSharingRenderer=initContentSharingRenderer(),confUI.startScreenShareReceive())}),collaboration.getContentSharing().addOnContentSharingEndedCallback(()=>{startLocalVideo2(localStream),console.log("addOnContentSharingEndedCallback")})}),collaboration.addOnCollaborationServiceUnavailableCallback(()=>{}),collaboration.start().catch(e=>{console.log("Error starting collaboration: "+e)})})),call.addOnCallEstablishedCallback((function(e){conferenceCall=e;let n={category:"tracksstatus",content:{mediaSession:{audio:!0,connected:!0,screenshare:!1,selfMuted:!1,video:!0}},topicId:spaceId};socketConnection.emit("SEND_MEDIA_SESSION_EVENTS",n);let o={category:"app.event.presence.party.online",content:{desktop:!1,idle:!1,mediaSession:{audio:!0,connected:!0,phone:!1,screenshare:!1,selfMuted:!1,video:!0},offline:!1,role:"guest"},topicId:spaceId};socketConnection.emit("SEND_PRESENCE_EVENT",o),inCall=!0;try{collaborations=user.getCollaborations(),(collaboration=collaborations.getCollaborationForCall(e.getCallId())).addOnCollaborationStartedCallback(()=>{console.log("Collaboration Started event...")}),collaboration.addOnCollaborationInitializedCallback(()=>{console.log("Collaboration Initialized event...")}),collaboration.addOnCollaborationServiceAvailableCallback(()=>{console.log("Collaboration Service Available event...")}),collaboration.getContentSharing().addOnContentSharingEndedCallback(()=>{console.log("Content Sharing Ended event..."),confUI.stopScreenShare(),updateScreensharePresence(!1)})}catch(e){console.log("Error: "+e.message)}})),call.start()}function populateChats(){$.ajax({headers:{Authorization:"jwt "+token,Accept:"application/json","spaces-x-space-password":password},url:"https://spacesapis.avayacloud.com/api/spaces/"+spaceId+"/messages/query?category=chat&size=50",type:"GET",dataType:"json",success:function(e){var n=e.total;for(i=n-1;i>=0;i--){var o;if(msg=e.data[i],void 0!==msg.content.data&&msg.content.data.length>0&&(o=msg.sender.displayname+": "+msg.content.data[0].name+" "+msg.content.data[0].path),o.includes("<p>")){var t=msg.content.bodyText.length;o=msg.sender.displayname+": "+msg.content.bodyText.substring(3,t-4).replace(new RegExp("&#x27;","g"),"'").replace(/&quot;/g,'"')}else o=msg.sender.displayname+": "+o.replace(new RegExp("&#x27;","g"),"'").replace(/&quot;/g,'"');trace(o)}},error:function(e){console.log("Chats error"),console.log("Error "+e)}})}function initContentSharingRenderer(){var e=new AvayaClientServices.Renderer.Konva.KonvaContentSharingRenderer;return e.init(collaboration.getContentSharing(),"screenReceiveFrame"),e}function setZoom(e){confUI.contentSharingRendererZoom+=e,void 0!==e&&(e=Math.max(Math.min(confUI.contentSharingRendererZoom,confUI.maxZoomValue),confUI.minZoomValue),contentSharingRenderer.zoom(confUI.contentSharingRendererZoom))}function resetZoom(){confUI.contentSharingRendererZoom=1,contentSharingRenderer.zoom(confUI.contentSharingRendererZoom)}function joinSpace(){input=document.getElementById("password").value,password=""!=input.trim()?document.getElementById("password").value:null,$.ajax({headers:{Authorization:"jwt "+token,Accept:"application/json","spaces-x-space-password":password},url:"https://spacesapis.avayacloud.com/api/spaces/"+spaceId+"/join",type:"GET",success:function(e){var n={query:"token="+token+"&tokenType=jwt",transports:["websocket"]};(socketConnection=io.connect("https://spacesapis-socket.zang.io/chat",n)).on("connect",(function(){var e={channel:{_id:spaceId,type:"topic",password:password}};socketConnection.emit("SUBSCRIBE_CHANNEL",e)})),socketConnection.on("CHANNEL_SUBSCRIBED",e=>{let n={category:"app.event.presence.party.online",content:{desktop:!1,idle:!1,mediaSession:{audio:!1,connected:!1,phone:!1,screenshare:!1,selfMuted:!0,video:!1},offline:!1,role:"guest"},topicId:spaceId,loopbackMetadata:"some metadata"};socketConnection.emit("SEND_PRESENCE_EVENT",n),startVideoForSpaces(),confUI.openSpacesConference()}),socketConnection.on("MESSAGE_SENT",(function(e){if("chat"==e.category){var n;if(n=e.content.bodyText,e.content.data.length>0)n=e.sender.displayname+": "+e.content.data[0].name+" "+e.content.data[0].path;else if(n.includes("<p>")){var o=e.content.bodyText.length;n=e.sender.displayname+": "+e.content.bodyText.substring(3,o-4).replace(new RegExp("&#x27;","g"),"'").replace(/&quot;/g,'"')}else n=e.sender.displayname+": "+n.replace(new RegExp("&#x27;","g"),"'").replace(/&quot;/g,'"');trace(n),(e.content.bodyText.includes("@abc")||e.content.bodyText.includes("@ABC")||e.content.bodyText.includes("@bot"))&&sendToDialogflow(e.content.bodyText.substring(5))}})),socketConnection.on("connect_error",(function(e){})),socketConnection.on("error",(function(e){})),socketConnection.on("disconnect",(function(){})),socketConnection.on("PRESENCE_EVENT_RESPONSE",(function(e){if("app.event.presence.party.online"==e.category)peopleInMeeting.push(e.sender),confUI.displayPeopleInMeeting(peopleInMeeting),console.log(e.sender.displayname+" is online.");else if("app.event.presence.party.leaves"==e.category)peopleInMeeting=peopleInMeeting.filter((function(n){return n._id!=e.sender._id})),confUI.displayPeopleInMeeting(peopleInMeeting),console.log(e.sender.displayname+" has left the room.");else if("app.event.presence.request.parties"==e.category){let e={category:"app.event.presence.party.online",content:{desktop:!1,idle:!1,mediaSession:{audio:audioUnmuted,connected:!0,phone:!1,screenshare:onScreenShare,selfMuted:!1,video:videoUnmuted},offline:!1,role:"guest"},topicId:spaceId};socketConnection.emit("SEND_PRESENCE_EVENT",e)}})),socketConnection.on("MEDIA_SESSION_RESPONSE",e=>{"app.event.recording.started"==e.category&&(console.log("Recording Started Data recording Id: "+e.sender._id),recordingId=e.content.recordings[0]._id),"app.event.meeting.started"==e.category&&(console.log("Meeting Started"),console.log("Meeting Started Attendees: ",e.content.attendees)),"app.event.attendee.added"==e.category&&(attendeeId||(attendeeId=e.content.attendee._id,peopleInMeeting.push(e.content.attendee),confUI.displayPeopleInMeeting(peopleInMeeting)))}),socketConnection.on("SEND_MESSAGE_FAILED",(function(e){}))},error:function(e){window.alert("The room could not be joined.")}})}function sendMessage(e){var n={content:{bodyText:e},category:"chat",topicId:spaceId};socketConnection.emit("SEND_MESSAGE",n)}function getSpacesToken(){return""!=document.getElementById("userName").value.trim()&&(userName=document.getElementById("userName").value),new Promise((function(e,n){$.ajax("https://spacesapis.avayacloud.com/api/anonymous/auth",{data:JSON.stringify({displayname:userName,username:"Anonymous",room:DEFAULT_ROOM}),contentType:"application/json",type:"POST",success:n=>{token=n.token,e(n)},error:()=>{n(null)}})}))}function closeSpacesConference(){if(socketConnection){let e={channel:{type:"topic",_id:spaceId}};socketConnection.emit("UNSUBSCRIBE_CHANNEL",e);let n={category:"app.event.presence.party.leaves",content:{desktop:!1,idle:!0,mediaSession:{audio:!1,connected:!1,phone:!1,screenshare:!1,selfMuted:!0,video:!1},offline:!0,role:"guest"},topicId:spaceId,loopbackMetadata:"some metadata"};socketConnection.emit("SEND_PRESENCE_EVENT",n),conferenceCall&&(conferenceCall.end(),stopLocalVideo(),stopRemoteVideo())}init(),token=null,clearTrace(),1==document.getElementById("delete").checked&&deleteRoomAccessToken(),confUI.closeSpacesConference()}function muteVideo(){if(socketConnection){if(0==videoUnmuted)return void unmuteVideo();videoUnmuted=!1,conferenceCall.muteVideo().then((function(){let e={category:"app.event.presence.party.online",content:{desktop:!1,idle:!1,mediaSession:{audio:audioUnmuted,connected:!0,phone:!1,screenshare:onScreenShare,selfMuted:!1,video:videoUnmuted},offline:!1,role:"guest"},topicId:spaceId,loopbackMetadata:"some metadata"};socketConnection.emit("SEND_PRESENCE_EVENT",e);let n={category:"tracksstatus",content:{mediaSession:{audio:audioUnmuted,connected:!0,screenshare:onScreenShare,selfMuted:!1,video:videoUnmuted}},topicId:spaceId};socketConnection.emit("SEND_MEDIA_SESSION_EVENTS",n)}),(function(){console.log("mute video failure")})),confUI.muteVideo()}}function unmuteVideo(){socketConnection&&(videoUnmuted=!0,conferenceCall.unmuteVideo().then((function(){let e={category:"app.event.presence.party.online",content:{desktop:!1,idle:!1,mediaSession:{audio:audioUnmuted,connected:!0,phone:!1,screenshare:onScreenShare,selfMuted:!1,video:videoUnmuted},offline:!1,role:"guest"},topicId:spaceId,loopbackMetadata:"some metadata"};socketConnection.emit("SEND_PRESENCE_EVENT",e);let n={category:"tracksstatus",content:{mediaSession:{audio:audioUnmuted,connected:!0,screenshare:onScreenShare,selfMuted:!1,video:videoUnmuted}},topicId:spaceId};socketConnection.emit("SEND_MEDIA_SESSION_EVENTS",n)}),(function(){console.log("unmute video failure")})),confUI.unmuteVideo())}function muteAudio(){if(socketConnection){if(0==audioUnmuted)return void unmuteAudio();audioUnmuted=!1,conferenceCall.muteAudio().then((function(){let e={category:"app.event.presence.party.online",content:{desktop:!1,idle:!1,mediaSession:{audio:!1,connected:!0,screenshare:onScreenShare,video:videoUnmuted},offline:!1,role:"guest"},topicId:spaceId};socketConnection.emit("SEND_PRESENCE_EVENT",e);let n={category:"tracksstatus",content:{mediaSession:{audio:!1,connected:!0,screenshare:onScreenShare,selfMuted:!0,video:videoUnmuted}},topicId:spaceId};socketConnection.emit("SEND_MEDIA_SESSION_EVENTS",n)}),(function(){console.log("mute audio failure")})),confUI.muteAudio()}}function unmuteAudio(){socketConnection&&(audioUnmuted=!0,conferenceCall.unmuteAudio().then((function(){let e={category:"app.event.presence.party.online",content:{desktop:!1,idle:!1,mediaSession:{audio:!0,connected:!0,screenshare:onScreenShare,video:videoUnmuted},offline:!1,role:"guest"},topicId:spaceId};socketConnection.emit("SEND_PRESENCE_EVENT",e);let n={category:"tracksstatus",content:{mediaSession:{audio:!0,connected:!0,screenshare:onScreenShare,video:videoUnmuted}},topicId:spaceId};socketConnection.emit("SEND_MEDIA_SESSION_EVENTS",n)}),(function(){console.log("unmute audio failure")})),confUI.unmuteAudio())}function startRemoteVideo(e){document.querySelector("#remoteVideoElement").srcObject=e,"REMOTE"==confUI.presentedStream?$("#littleVideoDisplay")[0].srcObject=$("#localVideoElement")[0].srcObject:$("#littleVideoDisplay")[0].srcObject=$("#remoteVideoElement")[0].srcObject}function stopRemoteVideo(){document.querySelector("#remoteVideoElement").srcObject=null,document.querySelector("#littleVideoDisplay").srcObject=null}function startLocalVideo2(e){console.log("Starting local video"),document.querySelector("#localVideoElement").srcObject=e}function stopLocalVideo(){document.querySelector("#localVideoElement").srcObject=null}function checkQueryParameters(){const e=new URLSearchParams(window.location.search);var n=e.get("username"),o=e.get("room");o&&$("#roomNumber").val(o),n&&$("#userName").val(n)}$(document).ready(init),window.onbeforeunload=function(){return"Do you really want to close?"};