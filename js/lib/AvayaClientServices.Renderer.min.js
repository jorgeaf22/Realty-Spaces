!function(t,g){var C=jQuery;!function(t){"use strict";var e,i;(e=t).Renderer=e.Renderer||{},(i=t).Renderer.Konva=i.Renderer.Konva||{}}(AvayaClientServices),function(a){"use strict";function t(){this._contentSharing=g}t.prototype={init:function(t,n){(this._contentSharing=t).addOnCursorReceivedCallback(function(t,e){this.showCursor(e)}.bind(this)),t.addOnContentSharingStartedCallback(function(t,e){var i={konvaSharingFramesAvarageLimit:a.Base.Utils.queryJSONObject(t,"_collaboration._config.mediaConfiguration.voipConfigurationVideo.konvaSharingFramesAvarageLimit")||2.5,konvaSharingFramesWarningLimit:a.Base.Utils.queryJSONObject(t,"_collaboration._config.mediaConfiguration.voipConfigurationVideo.konvaSharingFramesWarningLimit")||1,konvaSharingGracePeriod:a.Base.Utils.queryJSONObject(t,"_collaboration._config.mediaConfiguration.voipConfigurationVideo.konvaSharingGracePeriod")||15,konvaSharingMeasurementsInterval:a.Base.Utils.queryJSONObject(t,"_collaboration._config.mediaConfiguration.voipConfigurationVideo.konvaSharingMeasurementsInterval")||.5,konvaSharingMeasurementsWindowDuration:a.Base.Utils.queryJSONObject(t,"_collaboration._config.mediaConfiguration.voipConfigurationVideo.konvaSharingMeasurementsWindowDuration")||10,konvaSharingDebugMode:a.Base.Utils.queryJSONObject(t,"_collaboration._config.mediaConfiguration.voipConfigurationVideo.konvaSharingDebugMode")||!1};this._setConfig(i),this.start(n)}.bind(this)),t.addOnContentSharingEndedCallback(function(t,e){this.stop()}.bind(this)),t.addOnContentSharingPausedCallback(function(t,e){this.pause()}.bind(this)),t.addOnContentSharingResumedCallback(function(t,e){this.unpause()}.bind(this)),t.addOnFrameReceivedCallback(function(t,e){this.drawFrame(e)}.bind(this)),t.addOnFrameChangedCallback(function(t,e){this.drawFrame(e)}.bind(this))},showCursor:function(t){},start:function(){},stop:function(){},pause:function(){},unpause:function(){},drawFrame:function(t){},onOverloaded:function(t){},performanceMonitorStart:function(){},performanceMonitorStop:function(){}},a.Renderer.ContentSharingRenderer=t}(AvayaClientServices),function(d){"use strict";function t(){this._tabVisibilityEventName=g,this._tabVisibilityStateName=g,this._tabVisibilityEventName=d.Base.Utils.getBrowserTabVisibilityParams()[0],this._tabVisibilityStateName=d.Base.Utils.getBrowserTabVisibilityParams()[1],this._state=d.Renderer.Konva.KonvaContentSharingState.STOPPED,this._width=0,this._height=0,this._cursor=g,Konva.pixelRatio=1,this._zoomLayer=new Konva.FastLayer,this._cursorLayer=new Konva.FastLayer,this._pauseLayer=new Konva.FastLayer,this._zoomStage=g,this._screenSharingBg=g,this._scale=1,this._screenSharingSession=0,this._htmlCanvas=g,this._currentFrame=g,this._queuedFrames=[],this._performanceMonitor=g}(t.prototype=Object.create(d.Renderer.ContentSharingRenderer.prototype))._handleVisibilityChange=function(){!d.Base.Utils.isApplicationTabActive(this._tabVisibilityStateName)||this._performanceMonitor||this._isContentSharingStopped()?this.performanceMonitorStop():this.performanceMonitorStart()},t.prototype.getWidth=function(){return this._width},t.prototype.getHeight=function(){return this._height},t.prototype.drawFrame=function(t){if(!this._isContentSharingStopped())try{if(this._currentFrame)return void(t.isKeyFrame()?(d.Base.Logger.debug(d.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Queuing a key frame for rendering and wiping the queue of "+this._queuedFrames.length+" frames. "),this._queuedFrames=[t]):(this._queuedFrames.push(t),d.Base.Logger.debug(d.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Queued an intra frame for rendering.  Queue size: "+this._queuedFrames.length)));this._currentFrame=t,d.Base.Logger.debug(d.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Drawing a "+(t.isKeyFrame()?"key":"intra")+" frame. "),this._width!==t.getWidth()&&0<t.getWidth()&&(this._zoomStage.setWidth(t.getWidth()*this._scale),this._width=t.getWidth(),this._htmlCanvas.width=this._width,this._state===d.Renderer.Konva.KonvaContentSharingState.PAUSED&&this._redrawPauseLayer()),this._height!==t.getHeight()&&0<t.getHeight()&&(this._zoomStage.setHeight(t.getHeight()*this._scale),this._height=t.getHeight(),this._htmlCanvas.height=this._height,this._state===d.Renderer.Konva.KonvaContentSharingState.PAUSED&&this._redrawPauseLayer());var e=this._screenSharingSession,i=t.getBitmaps().map(this._generateImage.bind(this));C.when.apply(this,i).then(function(){if(Object.values(arguments).forEach(function(t){if(d.Base.Utils.isDefined(t))try{this._canvasContext&&e===this._screenSharingSession?this._canvasContext.drawImage(t.image,t.bitmap.getXOffset(),t.bitmap.getYOffset()):d.Base.Logger.debug(d.Renderer.LoggerTags.KONVA_WHITEBOARD_RENDERER,"Skip draw image because sharing has stopped or changed")}catch(t){d.Base.Logger.error(d.Renderer.LoggerTags.KONVA_WHITEBOARD_RENDERER,"Error while processing loaded image. ",t)}finally{window.URL.revokeObjectURL(t.image.src)}}.bind(this)),this._drawReceivedFrame(e),this._currentFrame=g,0<this._queuedFrames.length){var t=this._queuedFrames.shift();d.Base.Logger.debug(d.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"De-queuing a "+(t.isKeyFrame()?"key":"intra")+" frame for rendering. "),this.drawFrame(t)}}.bind(this))}catch(t){d.Base.Logger.debug(d.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Error when drawing a frame: "+t),this._currentFrame=g}},t.prototype._drawReceivedFrame=function(t){if(!this._isContentSharingStopped()&&this._screenSharingSession===t){var e=this._getImageFromCanvas(this._htmlCanvas);this._zoomLayer.removeChildren(),this._zoomLayer.add(e),this._zoomLayer.draw()}},t.prototype._getImageFromCanvas=function(t){return new Konva.Image({x:0,y:0,image:t})},t.prototype._isContentSharingStopped=function(){return this._state===d.Renderer.Konva.KonvaContentSharingState.STOPPED},t.prototype._generateImage=function(e){var i=C.Deferred(),n=new Image,a=this._screenSharingSession;return n.onload=function(){if(this._config&&this._config.konvaSharingDebugMode){(t=C.Deferred(),setTimeout(function(){t.resolve()},2e3),t.promise()).then(function(){a===this._screenSharingSession&&this._canvasContext?i.resolve({bitmap:e,image:n}):(window.URL.revokeObjectURL(n.src),d.Base.Logger.debug(d.Renderer.LoggerTags.KONVA_WHITEBOARD_RENDERER,"Ignoring an image that loaded after its sharing session ended."),i.resolve())}.bind(this))}else a===this._screenSharingSession&&this._canvasContext?i.resolve({bitmap:e,image:n}):(window.URL.revokeObjectURL(n.src),d.Base.Logger.debug(d.Renderer.LoggerTags.KONVA_WHITEBOARD_RENDERER,"Ignoring an image that loaded after its sharing session ended."),i.resolve());var t}.bind(this),n.onerror=function(){d.Base.Logger.warn(d.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"An image failed to load."),i.resolve(),window.URL.revokeObjectURL(n.src)},n.src=e.getBlobData(),i.promise()},t.prototype._setConfig=function(t){this._config=t},t.prototype.showCursor=function(t){if(!this._isContentSharingStopped()){var e=new Konva.Tween({node:this._cursor,duration:.1,easing:Konva.Easings.EaseIn,x:t.getX(),y:t.getY(),onFinish:function(){e.destroy()}});e.play()}},t.prototype.stop=function(){d.Base.Logger.info(d.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Screen sharing stopped. Sharing SessionId: "+this._screenSharingSession),this._queuedFrames=[],this._htmlCanvas=g,this._canvasContext=g,this._zoomLayer.destroyChildren(),this._cursorLayer.destroyChildren(),this._pauseLayer.destroyChildren(),this._width=0,this._height=0,this._zoomStage&&(this._zoomStage.destroyChildren(),this._zoomStage.setWidth(0),this._zoomStage.setHeight(0),this._zoomStage.draw(),this._zoomStage.destroy(),this._zoomStage=g),C(this._screenSharingBg).remove(),this._screenSharingBg=g,document.removeEventListener(this._tabVisibilityEventName,this._handleVisibilityChange.bind(this),!1),this.performanceMonitorStop(),this._config=g,this._state=d.Renderer.Konva.KonvaContentSharingState.STOPPED},t.prototype.start=function(t){if(this._isContentSharingStopped()){d.Base.Logger.info(d.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Screen sharing started.");var e=document.createElement("div");e.setAttribute("id",t+"-bg"),e.classList.add("hide"),this._screenSharingBg=e,C("#"+t).parent().append(e),this._zoomStage=new Konva.Stage({container:t,width:this._width,height:this._height}),this._zoomStage.scale({x:this._scale,y:this._scale}),this._zoomStage.add(this._zoomLayer),this._zoomStage.add(this._cursorLayer),this._zoomStage.add(this._pauseLayer),this._htmlCanvas=document.createElement("canvas"),this._htmlCanvas.width=this._width,this._htmlCanvas.height=this._height,this._canvasContext=this._htmlCanvas.getContext("2d"),this._cursor=new Konva.Circle({x:-10,y:-10,radius:5,fill:"#EF5353"}),this._cursorLayer.add(this._cursor),this._state=d.Renderer.Konva.KonvaContentSharingState.STARTED,this._zoomLayer.destroyChildren(),this._zoomStage.draw()}else d.Base.Logger.info(d.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Screen sharing re-started. ",this._state);setTimeout(function(){this._isContentSharingStopped()||this.performanceMonitorStart()}.bind(this),1e3*this._config.konvaSharingGracePeriod),void 0===document.addEventListener||this._tabVisibilityStateName===g?d.Base.Logger.info(d.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Page Visibility API is not supported by this browser."):document.addEventListener(this._tabVisibilityEventName,this._handleVisibilityChange.bind(this),!1),this._screenSharingSession=this._screenSharingSession<1e4?this._screenSharingSession+1:0,d.Base.Logger.info(d.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Sharing SessionId: "+this._screenSharingSession)},t.prototype.pause=function(){d.Base.Logger.info(d.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Screen sharing paused."),this._state=d.Renderer.Konva.KonvaContentSharingState.PAUSED,0<this._width?this._redrawPauseLayer():this._contentSharing.isSharingApplicationWindow()||this._contentSharing.isSharingFullScreen()||this._contentSharing.isSharingApplicationWindow()===g||(this._width=800,this._height=600,this._zoomStage.setWidth(this._width*this._scale),this._zoomStage.setHeight(this._height*this._scale),this._redrawPauseLayer())},t.prototype._redrawPauseLayer=function(){this._pauseLayer.removeChildren();var t=new Konva.Rect({x:0,y:0,opacity:.1,width:this._width,height:this._height,fill:"#00897b"});this._pauseLayer.add(t);var e=new Konva.Rect({x:this._width/2-20-10,y:(this._height-80)/2,width:20,height:80,fill:"#00897b"});this._pauseLayer.add(e);var i=new Konva.Rect({x:this._width/2+10,y:(this._height-80)/2,width:20,height:80,fill:"#00897b"});this._pauseLayer.add(i),this._zoomStage.draw()},t.prototype.unpause=function(){d.Base.Logger.info(d.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Screen sharing un-paused."),this._state=d.Renderer.Konva.KonvaContentSharingState.STARTED,this._pauseLayer.removeChildren(),this._zoomStage.draw()},t.prototype.zoom=function(t){if(!this._isContentSharingStopped()){if(t<=0)throw new Error("Scale cannot be lower than 0.");t>=Number.POSITIVE_INFINITY||(this._scale=t,this._zoomStage.height(this._height*this._scale),this._zoomStage.width(this._width*this._scale),this._zoomStage.scale({x:this._scale,y:this._scale}),this._zoomStage.draw())}},t.prototype.autoFit=function(t,e){var i;return d.Base.Logger.debug(d.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Updating autofit to width: "+t+" height: "+e),i=this._width*e/this._height<t?e/this._height:t/this._width,this.zoom(i),i},t.prototype._saveFrameToDisk=function(t){var e=t.getBitmaps(),n=1,a=new JSZip;e.forEach(function(t){var e=0===t._imageType?"jpeg":"png",i=n+++"_"+t.getXOffset()+"_"+t.getYOffset()+"_"+t.getWidth()+"_"+t.getHeight()+"."+e;a.file(i,t.getRawBitmapData(),{base64:!0})}),a.generateAsync({type:"blob"}).then(function(t){saveAs(t,"download.zip")})},t.prototype.performanceMonitorStart=function(){var a=0,o=[],r=0,s=this._config,h=s.konvaSharingMeasurementsWindowDuration/s.konvaSharingMeasurementsInterval;d.Base.Logger.info(d.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Starting counting frames averages."),this._performanceMonitor=setInterval(function(){var t=this._queuedFrames.length;if(r++,a+=t,o.push(t),h<r){var e=o.shift();a-=e}if(h<=r){var i=a/h;if(!0===s.konvaSharingDebugMode&&d.Base.Logger.debug(d.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Counting frames averages, current step: "+r+", frames averages: "+i),t>s.konvaSharingFramesWarningLimit&&this._contentSharing._notifyPerformanceMonitorAlert(d.Base.PerformanceAlertType.CPU_USAGE_WARNING),i>s.konvaSharingFramesAvarageLimit){var n="Average frames queued is "+i;this._contentSharing._notifyPerformanceMonitorAlert(d.Base.PerformanceAlertType.CPU_USAGE_OVERLOADED,n)}}}.bind(this),1e3*s.konvaSharingMeasurementsInterval)},t.prototype.performanceMonitorStop=function(){this._performanceMonitor&&(clearInterval(this._performanceMonitor),this._performanceMonitor=g,d.Base.Logger.info(d.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Konva Renderer performance monitor was stopped."))},d.Renderer.Konva.KonvaContentSharingRenderer=t}(AvayaClientServices),function(t){"use strict";AvayaClientServices.Renderer.Konva.KonvaContentSharingState={STARTED:"STARTED",STOPPED:"STOPPED",PAUSED:"PAUSED"}}(),function(){"use strict";function t(){}t.prototype={convertRectangle:function(t){var e=!!t.attrs.fill,i=this._colorHexToInt(e?t.attrs.fill:t.attrs.stroke),n=t.attrs.strokeWidth||0,a=new AvayaClientServices.Services.Collaboration.Shape("",e,!0,i,void 0,n);return a.addMovePoint(new AvayaClientServices.Services.Collaboration.Point(t.attrs.x,t.attrs.y)),a.addLinePoint(new AvayaClientServices.Services.Collaboration.Point(t.attrs.x+t.attrs.width,t.attrs.y)),a.addLinePoint(new AvayaClientServices.Services.Collaboration.Point(t.attrs.x+t.attrs.width,t.attrs.y+t.attrs.height)),a.addLinePoint(new AvayaClientServices.Services.Collaboration.Point(t.attrs.x,t.attrs.y+t.attrs.height)),a.addLinePoint(new AvayaClientServices.Services.Collaboration.Point(t.attrs.x,t.attrs.y)),a.finishDrawing(),a},convertEllipse:function(t){var e=new AvayaClientServices.Services.Collaboration.Point(t.attrs.x-t.attrs.radiusX,t.attrs.y-t.attrs.radiusY),i=new AvayaClientServices.Services.Collaboration.Point(t.attrs.x+t.attrs.radiusX,t.attrs.y+t.attrs.radiusY),n=!!t.attrs.fill,a=this._colorHexToInt(n?t.attrs.fill:t.attrs.stroke),o=t.attrs.strokeWidth||0;return new AvayaClientServices.Services.Collaboration.Circle(e,i,"",n,!0,a,void 0,o)},convertText:function(t){var e=t.attrs.text,i=t.attrs.fontSize,n=this._colorHexToInt(t.attrs.fill),a=new AvayaClientServices.Services.Collaboration.WhiteboardText(e,i,"",!0,!0,n);return a.setPosition(new AvayaClientServices.Services.Collaboration.Point(t.attrs.x,t.attrs.y)),a},convertLine:function(t){var e=this._colorHexToInt(t.attrs.stroke),i=t.attrs.strokeWidth||0,n=new AvayaClientServices.Services.Collaboration.Shape("",!1,!0,e,void 0,i);return n.addMovePoint(new AvayaClientServices.Services.Collaboration.Point(t.attrs.points[0],t.attrs.points[1])),n.addLinePoint(new AvayaClientServices.Services.Collaboration.Point(t.attrs.points[2],t.attrs.points[3])),n.finishDrawing(),n},convertPolygon:function(t,e){var i=!!t.attrs.fill,n=this._colorHexToInt(i?t.attrs.fill:t.attrs.stroke),a=t.attrs.strokeWidth||0,o=100*t.attrs.opacity,r=new AvayaClientServices.Services.Collaboration.Shape("",i,!0,n,o,a);r.addMovePoint(new AvayaClientServices.Services.Collaboration.Point(t._modelStart.x,t._modelStart.y));for(var s=0;s<t._modelRelativePoints.length;s++){var h=t._modelRelativePoints[s];0!==h.x&&0!==h.y&&r.addLinePoint(new AvayaClientServices.Services.Collaboration.Point(t._modelStart.x+h.x,t._modelStart.y+h.y))}return e&&r.finishDrawing(),r},_colorHexToInt:function(t){return"#"===t[0]?parseInt("0x".concat(t.slice(1))):parseInt("0x".concat(t))}},AvayaClientServices.Renderer.Konva.KonvaWhiteboardConverter=t}(),function(r){"use strict";function t(){r.Services.Collaboration.WhiteboardRenderer.call(this),this._width=800,this._height=600,this._scale=1,this._drawingStage=g,this._drawingLayer=g,this._canvas=g,this._mode=r.Services.Collaboration.WhiteboardToolModes.STROKE,this._color="#211e1e",this._strokeWidth=6,this._whiteboardConverter=new r.Renderer.Konva.KonvaWhiteboardConverter,this._whiteboardTools=new r.Renderer.Konva.KonvaWhiteboardTools(this),this._tool=this._whiteboardTools[r.Services.Collaboration.WhiteboardToolTypes.RECTANGLE],this._isDrawing=!1,this._fontSize=19,this._annotatedShape=g,this._inputExists=!1,this._curWin=window,this._textAreaData=g}(t.prototype=Object.create(r.Services.Collaboration.WhiteboardRenderer.prototype)).getWidth=function(){return this._width},t.prototype.getHeight=function(){return this._height},t.prototype.start=function(t){this._setupWhiteboard(t),this._canvas=document.getElementById(t).getElementsByClassName("konvajs-content")[0].getElementsByTagName("canvas")[0],this._canvas.onmousedown=function(t){if(!this._whiteboard.getDrawingCapability().isAllowed)return r.Base.Logger.warn(r.Base.LoggerTags.COLLABORATION_SERVICE,"It is not possible to use any whiteboard tool since whiteboard is not available at the moment."),!1;switch(this._tool.type){case r.Services.Collaboration.WhiteboardToolTypes.SELECTION:return;case r.Services.Collaboration.WhiteboardToolTypes.RECTANGLE:case r.Services.Collaboration.WhiteboardToolTypes.CIRCLE:return void this._dragTool(t);case r.Services.Collaboration.WhiteboardToolTypes.MARKER:case r.Services.Collaboration.WhiteboardToolTypes.PEN:return void this._liveTool(t);case r.Services.Collaboration.WhiteboardToolTypes.LINE:return void this._dragTool(t);case r.Services.Collaboration.WhiteboardToolTypes.STAMP:return void this._stampTool(t);case r.Services.Collaboration.WhiteboardToolTypes.TEXT:return void this._textTool(t);case r.Services.Collaboration.WhiteboardToolTypes.DELETE:return void this._deleteShape(t);case r.Services.Collaboration.WhiteboardToolTypes.CLEAR:return}}.bind(this)},t.prototype.end=function(t){this._drawingLayer&&(this._canvas.onmousedown=g,this._drawingLayer.destroyChildren(),this._drawingStage.destroyChildren(),this._drawingLayer.destroy(),this._drawingStage.destroy(),document.getElementById(t).innerHTML="",this._drawingLayer=g,this._drawingStage=g)},t.prototype.drawShape=function(e){if(this._drawingLayer){var t;if(this._drawingLayer.children.filter(function(t){return t.id===e.getId()}).length){var i=this._whiteboard.getActiveSurface().getShapes()[e.getId()];return void(r.Base.Utils.isDefined(i._ownerDisplayName)&&""!==i._ownerDisplayName||(i._ownerDisplayName=e.getOwnerDisplayName()))}if(e instanceof r.Services.Collaboration.Shape)t=this._createShape(e);else if(e instanceof r.Services.Collaboration.Circle)t=this._createCircle(e);else{if(!(e instanceof r.Services.Collaboration.WhiteboardText))return;t=this._createText(e)}this._drawingLayer.add(t),this._drawingLayer.draw()}},t.prototype.removeShape=function(t){var e=this._getKonvaShape(t);e&&(e.destroy(),this._drawingLayer.draw())},t.prototype._deleteShape=function(t){var e=this._drawingLayer.getIntersection({x:t.offsetX,y:t.offsetY});if(null!==e){var i=this._getSDKShape(e);if(i.isMine())return this.removeShape(i),this._whiteboard.getActiveSurface().removeShape(i)}var n=C.Deferred();return n.reject(),n.promise()},t.prototype.updateShape=function(n){var t,e,a=this._getKonvaShape(n);a&&n.getId()!==a.id&&(a.id=n.getId()),a instanceof Konva.Ellipse&&r.Base.Utils.isDefined(n.getTranslation())?(t=a.initX+n.getTranslation().getX(),e=a.initY+n.getTranslation().getY()):a instanceof Konva.Text&&r.Base.Utils.isDefined(n.getPosition())?(t=n.getPosition().getX()+n.getTranslation().getX(),e=n.getPosition().getY()+n.getTranslation().getY()):a instanceof Konva.Shape&&(r.Base.Utils.isDefined(n.getTranslation())?e=a instanceof Konva.Rect?(t=n.getPoints()[0].point.getX()+n.getTranslation().getX(),n.getPoints()[0].point.getY()+n.getTranslation().getY()):(t=n.getTranslation().getX(),n.getTranslation().getY()):a.attrs.sceneFunc=function(t){t.beginPath();for(var e=n.getPoints(),i=0;i<e.length;i++)e[i].isMove?t.moveTo(e[i].point.getX(),e[i].point.getY()):t.lineTo(e[i].point.getX(),e[i].point.getY());t.fillStrokeShape(a)}.bind(this)),r.Base.Utils.isDefined(t)&&r.Base.Utils.isDefined(e)&&a.position({x:t,y:e}),this._drawingLayer.draw()},t.prototype.clearContent=function(){if(r.Base.Utils.isDefined(this._drawingLayer)){for(var t=this._drawingLayer.children.length-1;0<=t;t--)this._drawingLayer.children[t].destroy();this._drawingLayer.draw()}},t.prototype.setTool=function(t,e){r.Base.Logger.debug(r.Renderer.LoggerTags.KONVA_WHITEBOARD_RENDERER,"Tool set: ",t,e),this._tool.type===r.Services.Collaboration.WhiteboardToolTypes.SELECTION&&this._drawingLayer&&this._unsetDraggable(),this._tool.type===r.Services.Collaboration.WhiteboardToolTypes.TEXT&&this._destructTextTool(),this._tool=this._whiteboardTools[t],e&&this._tool.modes[e]&&(this._mode=e),r.Base.Utils.isDefined(this._canvas)&&t!==r.Services.Collaboration.WhiteboardToolTypes.SELECTION&&t!==r.Services.Collaboration.WhiteboardToolTypes.DELETE&&(this._canvas.onmousemove=g,this._canvas.onmouseout=g,r.Base.Utils.isDefined(this._annotatedShape)&&(this._onShowShapeAnnotationCallbacks.fire(),this._annotatedShape=g)),!r.Base.Utils.isDefined(this._canvas)||t!==r.Services.Collaboration.WhiteboardToolTypes.SELECTION&&t!==r.Services.Collaboration.WhiteboardToolTypes.DELETE||(this._canvas.onmousemove=function(t){var e=this._drawingLayer.getIntersection({x:t.offsetX,y:t.offsetY});if(null!==e&&!r.Base.Utils.isDefined(this._annotatedShape)||null!==e&&r.Base.Utils.isDefined(this._annotatedShape)&&e._id!==this._annotatedShape._id){var i=this._getSDKShape(e);this._onShowShapeAnnotationCallbacks.fire(i),this._annotatedShape=e}else null===e&&r.Base.Utils.isDefined(this._annotatedShape)&&(this._onShowShapeAnnotationCallbacks.fire(),this._annotatedShape=g)}.bind(this),this._canvas.onmouseout=function(t){r.Base.Utils.isDefined(this._annotatedShape)&&(this._onShowShapeAnnotationCallbacks.fire(),this._annotatedShape=g)}.bind(this)),t===r.Services.Collaboration.WhiteboardToolTypes.SELECTION&&this._setDraggable(),t===r.Services.Collaboration.WhiteboardToolTypes.CLEAR&&this._clear()},t.prototype._destructTextTool=function(){var t=this._canvas.parentNode.querySelector("#"+this._getTextInputId());t&&(t.value?this._renderText(g,t):t.parentNode.removeChild(t),this._textAreaData=g)},t.prototype._getTextInputId=function(){return this._whiteboardTools[r.Services.Collaboration.WhiteboardToolTypes.TEXT]._getElementId()},t.prototype._renderText=function(t,e){var i=this._tool.endInput(t,this._canvas,e,this._scale);i.fill(this._color),i.fontSize(r.Services.Collaboration.WhiteboardTextSizes[this._mode]),i.fontStyle("bold"),this._drawingLayer.add(i),this._drawingLayer.draw(),this._convertAndAddShape(i,this._tool.name)},t.prototype.setColor=function(t){r.Base.Logger.debug(r.Renderer.LoggerTags.KONVA_WHITEBOARD_RENDERER,"Color set: ",t),this._color=t},t.prototype.zoom=function(t){if(t<=0)throw new Error("Scale cannot be lower than 0.");t>=Number.POSITIVE_INFINITY||(this._scale=t,this._drawingLayer.scale({x:this._scale,y:this._scale}),this._drawingLayer.draw(),this._drawingStage.height(this._height*this._scale),this._drawingStage.width(this._width*this._scale),this._zoomTool())},t.prototype._zoomTool=function(){if(this._tool.type===r.Services.Collaboration.WhiteboardToolTypes.TEXT&&this._canvas.parentNode){var t=this._canvas.parentNode.querySelector("#"+this._getTextInputId());t&&this._textAreaData.textTool._zoom(t,this._textAreaData,this._canvas,this._mode,this._scale)}},t.prototype.resubscribeWinEvents=function(){var t=this._canvas.ownerDocument.defaultView;t&&this._curWin!==t&&(Konva.DD._endDragBefore&&(this._curWin.removeEventListener("mouseup",Konva.DD._endDragBefore,!0),this._curWin.removeEventListener("touchend",Konva.DD._endDragBefore,!0),t.addEventListener("mouseup",Konva.DD._endDragBefore,!0),t.addEventListener("touchend",Konva.DD._endDragBefore,!0)),Konva.DD._drag&&(this._curWin.removeEventListener("mousemove",Konva.DD._drag),this._curWin.removeEventListener("touchmove",Konva.DD._drag),t.addEventListener("mousemove",Konva.DD._drag),t.addEventListener("touchmove",Konva.DD._drag)),Konva.DD._endDragAfter&&(this._curWin.removeEventListener("mouseup",Konva.DD._endDragAfter,!1),this._curWin.removeEventListener("touchend",Konva.DD._endDragAfter,!1),t.addEventListener("mouseup",Konva.DD._endDragAfter,!1),t.addEventListener("touchend",Konva.DD._endDragAfter,!1)),this._drawingStage&&this._drawingStage._bindContentEvents&&this._drawingStage._bindContentEvents(),this._curWin=t)},t.prototype.autoFit=function(t,e){var i;return i=this._width*e/this._height<t?e/this._height:t/this._width,this.zoom(i),i},t.prototype._textTool=function(t){var e=this._canvas.parentNode.querySelector("#"+this._getTextInputId());e?this._inputExists&&this._renderText(t,e):(this._textAreaData=this._tool.startInput(t,this._canvas,this._mode,this._scale),this._inputExists=!0)},t.prototype._dragTool=function(t){var e;this._isDrawing=!0,e=this._tool.startFunction(t,this._mode,this._scale);var i=function(t){this._isDrawing=!1,this._tool.endFunction(t),this._clearMouseEvents(),e.isMine=!0,this._convertAndAddShape(e,this._tool.name)}.bind(this);this._canvas.onmouseup=function(t){i(t)}.bind(this),this._canvas.onmouseleave=function(t){i(t)}.bind(this)},t.prototype._liveTool=function(t){var i;this._isDrawing=!0,i=this._tool.startFunction(t,this._scale);var n=this._whiteboardConverter.convertPolygon(i,!1),e=function(t){this._isDrawing=!1,this._tool.endFunction(t),this._clearMouseEvents(),i.isMine=!0,n.isFinished()||n.finishDrawing().done(function(t){this._updateShapeId(i,t)}.bind(this))}.bind(this);return this._canvas.onmousemove=function(t){this._tool.drawFunction(t,i);var e=new r.Services.Collaboration.Point(t.offsetX/this._scale,t.offsetY/this._scale);!function(t,e){if(1<t.length){var i=t.length-2,n=t.length-1;(function(t,e,i){var n={};n.gradient=(t.point.getY()-e.point.getY())/(t.point.getX()-e.point.getX()),n.interceptY=t.point.getY()-n.gradient*t.point.getX();var a=i.point.getY()===n.gradient*i.point.getX()+n.interceptY,o=t.point.getX()===e.point.getX()&&e.point.getX()===i.point.getX()||t.point.getY()===e.point.getY()&&e.point.getY()===i.point.getY();return a&&(1===n.gradient||-1===n.gradient)||o})(t[i],t[n],e)&&t.splice(n,1)}}(n.getPoints(),{point:e}),n.addLinePoint(e)}.bind(this),this._canvas.onmouseup=function(t){e(t)}.bind(this),this._canvas.onmouseleave=function(t){e(t)}.bind(this),this._whiteboard.getActiveSurface().addShape(n).done(function(t){this._updateShapeId(i,t)}.bind(this))},t.prototype._stampTool=function(t){var e;this._isDrawing=!0,(e=this._tool.drawFunction(t,this._scale)).isMine=!0,this._isDrawing=!1,this._convertAndAddShape(e,this._tool.name)},t.prototype._clear=function(){return this.clearContent(),this._whiteboard.getActiveSurface().clearContent()},t.prototype._createShape=function(t){var n=t.getPoints(),e=new Konva.Shape({fill:t.isFilled()?r.Base.Utils.colorIntToHex(t.getColor()):g,stroke:t.isFilled()?g:r.Base.Utils.colorIntToHex(t.getColor()),strokeWidth:t.isFilled()?g:t.getWidth(),lineCap:"round",lineJoin:"round",opacity:t.getAlpha()/100,sceneFunc:function(t){t.beginPath();for(var e,i=0;i<n.length;i++)(e=n[i]).isMove?t.moveTo(e.point.getX(),e.point.getY()):t.lineTo(e.point.getX()+.1,e.point.getY()+.1);t.fillStrokeShape(this)}});return r.Base.Utils.isDefined(t.getTranslation())&&e.position({x:t.getTranslation().getX(),y:t.getTranslation().getY()}),this._addCommonData(t,e)},t.prototype._moveShape=function(t,e){var i=this._getSDKShape(t),n=e.newPositionX-e.selectionX,a=e.newPositionY-e.selectionY,o=i.getTranslation();r.Base.Utils.isDefined(o)?i.setTranslation(new r.Services.Collaboration.Point(o.getX()+n,o.getY()+a)):i.setTranslation(new r.Services.Collaboration.Point(n,a)),this._whiteboard.getActiveSurface().updateShape(i)},t.prototype._createCircle=function(t){var e=new Konva.Ellipse({x:t.getTopLeft().getX()+(t.getBottomRight().getX()-t.getTopLeft().getX())/2,y:t.getTopLeft().getY()+(t.getBottomRight().getY()-t.getTopLeft().getY())/2,radius:{x:(t.getBottomRight().getX()-t.getTopLeft().getX())/2,y:(t.getBottomRight().getY()-t.getTopLeft().getY())/2},fill:t.isFilled()?r.Base.Utils.colorIntToHex(t.getColor()):g,stroke:t.isFilled()?g:r.Base.Utils.colorIntToHex(t.getColor()),strokeWidth:t.isFilled()?g:t.getWidth()});return e.initX=e.attrs.x,e.initY=e.attrs.y,r.Base.Utils.isDefined(t.getTranslation())&&e.position({x:e.initX+t.getTranslation().getX(),y:e.initY+t.getTranslation().getY()}),this._addCommonData(t,e)},t.prototype._createText=function(t){var e=new Konva.Text({x:t.getPosition().getX(),y:t.getPosition().getY(),fill:r.Base.Utils.colorIntToHex(t.getColor()),text:t.getContent(),fontSize:t.getFontSize(),fontFamily:"Arial",fontStyle:"bold",lineHeight:1.25});return r.Base.Utils.isDefined(t.getTranslation())&&e.position({x:t.getPosition().getX()+t.getTranslation().getX(),y:t.getPosition().getY()+t.getTranslation().getY()}),this._addCommonData(t,e)},t.prototype._addCommonData=function(t,e){return e.id=t.getId(),e.ownerDisplayName=t.getOwnerDisplayName(),e.status=t.getStatus(),e.isMine=t.isMine(),e},t.prototype._setupWhiteboard=function(t){this._drawingStage&&this.end(t),this._drawingStage=new Konva.Stage({container:t,width:this._width,height:this._height}),this._drawingLayer=new Konva.Layer,this._drawingStage.add(this._drawingLayer),this.zoom(this._scale)},t.prototype._convertAndAddShape=function(e){var t;if(e instanceof Konva.Rect)return t=this._whiteboardConverter.convertRectangle(e),this._whiteboard.getActiveSurface().addShape(t).done(function(t){this._updateShapeId(e,t)}.bind(this));if(e instanceof Konva.Ellipse)return t=this._whiteboardConverter.convertEllipse(e),this._whiteboard.getActiveSurface().addCircle(t).done(function(t){this._updateShapeId(e,t)}.bind(this));if(e instanceof Konva.Line)return t=this._whiteboardConverter.convertLine(e),this._whiteboard.getActiveSurface().addShape(t).done(function(t){this._updateShapeId(e,t)}.bind(this));if(e instanceof Konva.Text)return t=this._whiteboardConverter.convertText(e),this._whiteboard.getActiveSurface().addText(t).done(function(t){this._updateShapeId(e,t)}.bind(this));if(e instanceof Konva.Shape){return t=this._whiteboardConverter.convertPolygon(e,!0),this._whiteboard.getActiveSurface().addShape(t).done(function(t){this._updateShapeId(e,t)}.bind(this))}},t.prototype._getKonvaShape=function(t){if(this._drawingLayer&&this._drawingLayer.children)for(var e=0;e<this._drawingLayer.children.length;e++)if(this._drawingLayer.children[e].id===t.getId()||this._drawingLayer.children[e].id===t._tempId)return this._drawingLayer.children[e]},t.prototype._getSDKShape=function(t){return this._whiteboard.getActiveSurface().getShapes()[t.id]},t.prototype._updateShapeId=function(t,e){t.id=e},t.prototype._setDraggable=function(){var t,e=this._drawingLayer.children;for(t=0;t<e.length;t++)e[t].isMine&&e[t].draggable(!0);this._drawingLayer.on("dragstart",function(t){this._tool.dragStart(t,this._scale);var i=t.target,e=i.getSelfRect(),n={x:e.x*this._scale,y:e.y*this._scale,width:e.width*this._scale,height:e.height*this._scale},a=null;i.dragBoundFunction&&i.setDragBoundFunc(function(t){a||(a=t);var e=i.dragBoundFunction(i,t,n,this._canvas.getBoundingClientRect(),a,this._scale);return a=e}.bind(this))}.bind(this)),this._drawingLayer.on("dragend",function(t){var e=t.target;this._tool.dragEnd(t,this._scale),e.setDragBoundFunc()}.bind(this)),this._drawingLayer.draw()},t.prototype._unsetDraggable=function(){var t,e=this._drawingLayer.children;for(t=0;t<e.length;t++)e[t].isMine&&e[t].draggable(!1);this._drawingLayer.off("dragstart"),this._drawingLayer.off("dragend"),this._drawingLayer.draw()},t.prototype._clearMouseEvents=function(){this._canvas.onmouseup=g,this._canvas.onmouseleave=g},r.Renderer.Konva.KonvaWhiteboardRenderer=t}(AvayaClientServices),function(){"use strict";function t(d){AvayaClientServices.Services.Collaboration.WhiteboardTools.call(this);var t=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.LINE],e=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.RECTANGLE],i=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.CIRCLE],n=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.STAMP],a=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.SELECTION],w=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.TEXT],o=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.MARKER],r=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.PEN],s=function(t,e,i,n,a,o){var r=0-.9*i.width,s=n.width-i.width*(1-.9),h=0-.9*i.height,d=n.height-i.height*(1-.9);return{x:Math.min(s,Math.max(r,e.x)),y:Math.min(d,Math.max(h,e.y))}},h=function(t,e,i,n,a,o){var r=i.width-.9*i.width-i.width/2,s=i.height-.9*i.height-i.height/2,h=r,d=n.width-r,l=s,g=n.height-s,c={x:Math.min(d,Math.max(h,e.x)),y:Math.min(g,Math.max(l,e.y))};if((e.x<0||e.x>n.width)&&(e.y<0||e.y>n.height)){var _={x:0,y:0};e.x<0?_.x=0:_.x=n.width,e.y<0?_.y=0:_.y=n.height,Math.min(r,s)<Math.sqrt(Math.pow(e.x-_.x,2)+Math.pow(e.y-_.y,2))&&(c=a)}return c},u=function(t,e,i,n){for(var a=0,o=0,r=t._modelRelativePoints,s=r.length<=5?2:5;o<r.length&&a<s;){var h=r[o].x/t._originalScale*n+e.x,d=r[o].y/t._originalScale*n+e.y;0<h&&h<i.width&&0<d&&d<i.height&&a++,o++}return a<s},f=function(t,e,i,n){var a={x:t.getPoints()[0]*n+e.x,y:t.getPoints()[1]*n+e.y},o={x:t.getPoints()[2]*n+e.x,y:t.getPoints()[3]*n+e.y},r=0,s=0;s=(r=a.x,o.x);for(var h=0;r<s&&h<5;){var d=(o.y-a.y)/(o.x-a.x)*(r-a.x)+a.y;0<r&&r<i.width&&0<d&&d<i.height&&h++,r+=4}return h<5},l=function(t,e,i,n,a,o){var r=t instanceof Konva.Text?.54:.9,s=t instanceof Konva.Text?.765:.9,h=-i.x-i.width*s,d=n.width-(i.x+i.width*(1-s)),l=-i.y-i.height*r,g=n.height-(i.y+i.height*(1-r)),c={x:Math.min(d,Math.max(h,e.x)),y:Math.min(g,Math.max(l,e.y))},_=e.x<-i.x||e.x>n.width-i.x-i.width;return(e.y<-i.y||e.y>n.height-i.y-i.height||_)&&(c=function(t,e,i,n,a,o){var r;if(t._modelRelativePoints){if(t._shapeType&&"Stamp"===t._shapeType)return o;r=u}else{if(!(t instanceof Konva.Line))return o;r=f}if(r(t,e,i,n)){var s={x:e.x,y:a.y};if(r(t,s,i,n)){var h={x:a.x,y:e.y};return r(t,h,i,n)?a:h}return s}return o}(t,e,n,o,a,c)),c};o.startFunction=function(t,i){var n=new Konva.Shape({stroke:d._color,strokeWidth:12,hitStrokeWidth:20,lineCap:"round",lineJoin:"round",opacity:.6,sceneFunc:function(t){t.beginPath();var e=0;for(t.moveTo(n._modelStart.x,n._modelStart.y);e<n._modelRelativePoints.length;e++)t.lineTo(n._modelRelativePoints[e].x/i,n._modelRelativePoints[e].y/i);t.fillStrokeShape(this)}});return n.setDragDistance(0),n.dragBoundFunction=l,n._modelStart={x:t.offsetX/i,y:t.offsetY/i},n._modelRelativePoints=[],n._originalScale=i,n._selfRectCoordinates={minX:999999,minY:999999,maxX:-999999,maxY:-999999},n.getSelfRect=function(){return{x:this._selfRectCoordinates.minX/i,y:this._selfRectCoordinates.minY/i,width:this._selfRectCoordinates.maxX/i-this._selfRectCoordinates.minX/i,height:this._selfRectCoordinates.maxY/i-this._selfRectCoordinates.minY/i}},d._drawingLayer.add(n),d._drawingLayer.draw(),n}.bind(this),o.drawFunction=function(t,e){e._modelRelativePoints.push({x:t.offsetX,y:t.offsetY}),e._selfRectCoordinates.minX=Math.min(e._selfRectCoordinates.minX,t.offsetX),e._selfRectCoordinates.minY=Math.min(e._selfRectCoordinates.minY,t.offsetY),e._selfRectCoordinates.maxX=Math.max(e._selfRectCoordinates.maxX,t.offsetX),e._selfRectCoordinates.maxY=Math.max(e._selfRectCoordinates.maxY,t.offsetY),d._drawingLayer.draw(),d._drawingStage.draw()},o.endFunction=function(){d._canvas.onmousemove=g}.bind(this),r.startFunction=function(t,i){var n=new Konva.Shape({stroke:d._color,strokeWidth:4,hitStrokeWidth:20,lineCap:"round",lineJoin:"round",opacity:1,sceneFunc:function(t){t.beginPath();var e=0;for(t.moveTo(n._modelStart.x,n._modelStart.y);e<n._modelRelativePoints.length;e++)t.lineTo(n._modelRelativePoints[e].x/i,n._modelRelativePoints[e].y/i);t.fillStrokeShape(this)}});return n.dragBoundFunction=l,n._modelStart={x:t.offsetX/i,y:t.offsetY/i},n._modelRelativePoints=[],n._originalScale=i,n._selfRectCoordinates={minX:999999,minY:999999,maxX:-999999,maxY:-999999},n.getSelfRect=function(){return{x:this._selfRectCoordinates.minX/i,y:this._selfRectCoordinates.minY/i,width:this._selfRectCoordinates.maxX/i-this._selfRectCoordinates.minX/i,height:this._selfRectCoordinates.maxY/i-this._selfRectCoordinates.minY/i}},n.setDragDistance(0),d._drawingLayer.add(n),d._drawingLayer.draw(),n}.bind(this),r.drawFunction=function(t,e){e._modelRelativePoints.push({x:t.offsetX,y:t.offsetY}),e._selfRectCoordinates.minX=Math.min(e._selfRectCoordinates.minX,t.offsetX),e._selfRectCoordinates.minY=Math.min(e._selfRectCoordinates.minY,t.offsetY),e._selfRectCoordinates.maxX=Math.max(e._selfRectCoordinates.maxX,t.offsetX),e._selfRectCoordinates.maxY=Math.max(e._selfRectCoordinates.maxY,t.offsetY),d._drawingLayer.draw(),d._drawingStage.draw()},r.endFunction=function(){d._canvas.onmousemove=g}.bind(this),w._getElementId=function(){return"canvasTextInput"},w.endInput=function(t,e,i,n){var a=parseInt(i.style.fontSize.replace("px","")),o=0;if(getComputedStyle){var r=parseInt(getComputedStyle(i).borderBottomWidth),s=parseInt(getComputedStyle(i).paddingLeft);r&&(o+=r),s&&(o+=s)}var h=new Konva.Text({x:parseInt(i.style.left)/n+o,y:parseInt(i.style.top)/n,text:i.value,fontFamily:"Arial",lineHeight:1.25,fontSize:a});return h.isMine=!0,h.fontStyle("bold"),h.dragBoundFunction=l,d._inputExists=!1,i.parentNode.removeChild(i),h},w.startInput=function(t,f,e,i){var v=f.getBoundingClientRect().width,p=f.getBoundingClientRect().height,y=document.createElement("textarea"),g=20,n=1,a=t.offsetY,c=t.offsetX,S=AvayaClientServices.Services.Collaboration.WhiteboardTextSizes[e]*i,_=!1;function m(){S=parseInt(y.style.fontSize.replace("px","")),v=f.getBoundingClientRect().width,p=f.getBoundingClientRect().height}function u(t){if(m(),n=1,t.split("").forEach(function(t,e,i){"\n"!==t||(n+=1)}),y.setAttribute("rows",n),AvayaClientServices.Base.Utils.getBrowserType()===AvayaClientServices.Base.BrowserType.IE){var e=y.id,i=C("#"+e);i.length&&i.height(1.32*n*S)}}return y.setAttribute("id",this._getElementId()),y.setAttribute("rows",n),y.style.cssText="z-Index: 101; outline: 0; font-family: 'Arial'; font-weight:bold; font-size:"+S+"px; position: absolute; top:"+t.offsetY.toString()+"px; left:"+t.offsetX.toString()+"px; overflow: hidden; width:"+g+"px; line-height:1.32; height: auto; margin:0; border: 1px solid rgb(106, 105, 105); background: white; border-radius: 1px; margin-top: -2px; white-space: pre; color:"+d._color,f.parentNode.appendChild(y),setTimeout(function(){y.focus()}),w._checkOutOfBounds(y,f),y.addEventListener("keypress",function(t){m();var e=t.target.value,i=e.length,n=t.keyCode,a=String.fromCharCode(t.keyCode),o=y.clientHeight,r=f.clientWidth;if(f.clientHeight<=o+S){if(13===n)return t.preventDefault(),!1;var s,h=t.target.selectionStart,d=0,l=e.split("");l.splice(h,0,a);for(var g=l.join(""),c=h;c<i+1;c++)if("\n"===g[c]){s=c;break}for(var _=h;0<=_;_--)if("\n"===g[_]){d=_;break}s&&(s+=1);var u=g.slice(d+1,s);if(r<w._calculateWidth(u,S))return t.preventDefault(),!1}w._checkOutOfBounds(y,f)}),y.addEventListener("input",function(t){m();var e=t.target.value;3500<e.length&&(t.target.value=e.slice(0,3500),e=t.target.value);var i=e.length,n=t.target.value.charCodeAt(i-1);if("insertFromPaste"===t.inputType||_){var a=t.target.value.split("\n"),o=Math.round(p/(1.32*S));a.length>o&&(a=a.slice(0,o)),e=function(t){m();for(var e=t.join("\n").split(""),i=0,n=Math.round(p/(1.32*S)),a=0;a<t.length;a++){var o=t[a],r=w._calculateWidth(o,S);if(v<r)for(var s=Math.ceil(r/v),h=0,d=0;d<s;d++){for(var l=o.slice(h,h+151),g=0;g<3500&&w._calculateWidth(l,S)>v;g++)l=l.substring(0,l.length-1);var c=l.split("");-1<l.indexOf(" ")&&h+l.length!==o.length?(e.splice(c.lastIndexOf(" ")+i+h,1,"\n"),h=h+c.lastIndexOf(" ")+1):h+l.length!==o.length&&(e.splice(c.length+i+h,0,"\n"),h=c.length+h)}i+=o.length+1}var _=e.join(""),u=_.split("\n");return u.length>n&&(_=u.slice(0,n).join("\n")),_}(a),t.target.value=e}if(10!==n||"insertFromPaste"===t.inputType||_)if((g=w._calculateWidth(e,S))<v){if(y.style.width=g+"px",y.getBoundingClientRect().left+g>f.getBoundingClientRect().right){var r=y.getBoundingClientRect().left+g-f.getBoundingClientRect().right;c-=r,y.style.left=c+"px"}u(t.target.value)}else{y.style.left=0,y.style.width=v+"px";var s=t.target.value.split("\n").slice(-1)[0],h=w._calculateWidth(s,S),d=s.indexOf(" "),l=e.split("");v<h&&(t.target.value=(-1<d?l.splice(l.lastIndexOf(" "),1,"\n"):l.splice(-1,0,"\n"),l.join("")),u(t.target.value))}else 1===i?t.target.value="":u(t.target.value);_=!1,w._checkOutOfBounds(y,f)}),y.addEventListener("paste",function(){_=!0}),{initialTop:a,initialLeft:c,initialCanvasHeigth:p,initialCanvasWidth:v,textTool:this}},w._calculateWidth=function(t,e){var i=document.createElement("span");i.style.cssText="font-weight:bold; top:400px; left:300px; line-height: normal; visibility:hidden; borderRadius: 1px; position: absolute; border: 1px  solid rgb(106, 105, 105); margin: 0; white-space: pre; padding:2px; display: inline-block; font-size:"+e+"px; font-family:'Arial'",i.innerHTML=t,document.body.appendChild(i);var n=i.getBoundingClientRect().width;return setTimeout(function(){document.body.removeChild(i)},100),n},w._adjustWidth=function(t){var e=t.value?t.value:" ",i=parseInt(t.style.fontSize.replace("px","")),n=w._calculateWidth(e,i);t.style.width=n+"px"},w._checkOutOfBounds=function(t,e){var i=t.clientHeight,n=t.clientWidth,a=t.offsetTop,o=t.offsetLeft;if(i+a>e.clientHeight){var r=e.clientHeight-i;r<0&&(r=0),t.style.top=r+"px"}if(n+o>e.clientWidth){var s=e.clientWidth-n;s<0&&(s=0),t.style.left=s+"px"}},w._zoom=function(t,e,i,n,a){var o=i.getBoundingClientRect().width,r=i.getBoundingClientRect().height*e.initialTop/e.initialCanvasHeigth;t.style.top=r+"px";var s=o*e.initialLeft/e.initialCanvasWidth;t.style.left=s+"px";var h=AvayaClientServices.Services.Collaboration.WhiteboardTextSizes[n]*a;t.style.fontSize=h+"px",this._adjustWidth(t),this._checkOutOfBounds(t,i)},a.dragStart=function(t,e){var i=t.target;this._clickData={eventX:t.evt.pageX/e,eventY:t.evt.pageY/e,x:i.x(),y:i.y()}},a.dragEnd=function(t,e){if(this._clickData){var i=t.target;d._moveShape(t.target,{selectionX:this._clickData.x,selectionY:this._clickData.y,newPositionX:i.x(),newPositionY:i.y()});this._clickData=g}},t.startFunction=function(t,e,a){var o={x:t.offsetX/a,y:t.offsetY/a},r={x:t.offsetX/a,y:t.offsetY/a};o.x===r.x&&o.y===r.y&&(r.x+=.1,r.y+=.1);var s=new Konva.Line({points:[o.x,o.y,r.x,r.y],stroke:d._color,strokeWidth:AvayaClientServices.Services.Collaboration.WhiteboardLineWidths[e],hitStrokeWidth:20,lineCap:"round",lineJoin:"round"});return s.setDragDistance(0),s.dragBoundFunction=l,d._drawingLayer.add(s),d._drawingLayer.draw(),d._canvas.onmousemove=function(t){if(t.shiftKey){var e=t.offsetX/a-o.x,i=t.offsetY/a-o.y,n=Math.atan(i/e);Math.abs(n)>3*Math.PI/2/2/2?(r.x=o.x,r.y=t.offsetY/a):Math.abs(n)>Math.PI/2/2/2?(r.x=t.offsetX/a,r.y=o.y+(r.x-o.x)*Math.sign(n)):(r.x=t.offsetX/a,r.y=o.y)}else r.x=t.offsetX/a,r.y=t.offsetY/a;s.attrs.points=[o.x,o.y,r.x,r.y],d._drawingLayer.draw(),d._drawingStage.draw()}.bind(this),s}.bind(this),t.endFunction=function(t){d._canvas.onmousemove=g}.bind(this),e.startFunction=function(t,e,i){var n;return"FILLED"===e?n=new Konva.Rect({x:t.offsetX/i,y:t.offsetY/i,width:1,height:1,fill:d._color}):"STROKE"===e&&(n=new Konva.Rect({x:t.offsetX/i,y:t.offsetY/i,width:AvayaClientServices.Services.Collaboration.WhiteboardLineWidths.LARGE,height:1,lineCap:"round",lineJoin:"round",stroke:d._color,strokeWidth:d._strokeWidth})),n.setDragDistance(0),n.dragBoundFunction=s,d._drawingLayer.add(n),d._drawingLayer.draw(),d._canvas.onmousemove=function(t){if(t.shiftKey){var e=Math.min(t.offsetY/i-n.attrs.y,t.offsetX/i-n.attrs.x);t.offsetY<n.attrs.y&&t.offsetX>n.attrs.x?(n.width(-e),n.height(e)):t.offsetY>n.attrs.y&&t.offsetX<n.attrs.x?(n.width(e),n.height(-e)):(n.width(e),n.height(e))}else n.width(t.offsetX/i-n.attrs.x),n.height(t.offsetY/i-n.attrs.y);d._drawingLayer.draw(),d._drawingStage.draw()}.bind(this),n}.bind(this),e.endFunction=function(t){d._canvas.onmousemove=g}.bind(this),i.startFunction=function(t,e,i){var n,a=t.offsetX/i,o=t.offsetY/i,r={x:t.offsetX/i,y:t.offsetY/i};return"FILLED"===e?n=new Konva.Ellipse({x:a+(r.x-a)/2,y:o+(r.y-o)/2,radius:{x:Math.abs(r.x-a)/2,y:Math.abs(r.y-o)/2},fill:d._color}):"STROKE"===e&&(n=new Konva.Ellipse({x:a+(r.x-a)/2,y:o+(r.y-o)/2,radius:{x:Math.abs(r.x-a)/2,y:Math.abs(r.y-o)/2},stroke:d._color,strokeWidth:d._strokeWidth})),n.setDragDistance(0),n.dragBoundFunction=h,d._drawingLayer.add(n),d._drawingLayer.draw(),d._canvas.onmousemove=function(t){if(r.x=t.offsetX/i,r.y=t.offsetY/i,t.shiftKey){var e=Math.min(r.y-o,r.x-a);n.radius({x:Math.abs(e)/2,y:Math.abs(e)/2}),r.x<a&&r.y>o?(n.x(a+e/2),n.y(o-e/2),n.initX=a+e/2,n.initY=o-e/2):(r.x>a&&r.y<o?(n.x(a-e/2),n.y(o+e/2),n.initX=a-e/2):(n.x(a+e/2),n.y(o+e/2),n.initX=a+e/2),n.initY=o+e/2)}else n.radius({x:Math.abs(r.x-a)/2,y:Math.abs(r.y-o)/2}),n.x(a+(r.x-a)/2),n.y(o+(r.y-o)/2),n.initX=a+(r.x-a)/2,n.initY=o+(r.y-o)/2;d._drawingLayer.draw(),d._drawingStage.draw()}.bind(this),n}.bind(this),i.endFunction=function(t){d._canvas.onmousemove=g}.bind(this),n.drawFunction=function(t,e){var i={x:t.offsetX/e,y:t.offsetY/e},n=[{x:0,y:0},{x:-10,y:-10},{x:-42,y:-10},{x:-42,y:10},{x:-10,y:10}],a=new Konva.Shape({fill:d._color,sceneFunc:function(t){t.beginPath(),t.moveTo(i.x,i.y);for(var e=1;e<n.length;e++)t.lineTo(i.x+n[e].x,i.y+n[e].y);t.closePath(),t.fillStrokeShape(this)}});return a._modelStart=i,a._modelRelativePoints=n,a._originalScale=e,a._shapeType="Stamp",a._selfRectCoordinates={minX:i.x-42,minY:i.y-10,maxX:i.x,maxY:i.y+10},a.getSelfRect=function(){return{x:this._selfRectCoordinates.minX,y:this._selfRectCoordinates.minY,width:this._selfRectCoordinates.maxX-this._selfRectCoordinates.minX,height:this._selfRectCoordinates.maxY-this._selfRectCoordinates.minY}},a.setDragDistance(0),a.dragBoundFunction=l,d._drawingLayer.add(a),d._drawingLayer.draw(),d._drawingStage.draw(),a}.bind(this)}t.prototype=Object.create(AvayaClientServices.Services.Collaboration.WhiteboardTools.prototype),AvayaClientServices.Renderer.Konva.KonvaWhiteboardTools=t}(),function(t){"use strict";AvayaClientServices.Renderer.LoggerTags={KONVA_WHITEBOARD_RENDERER:"KonvaWhiteboardRenderer",KONVA_CONTENT_SHARING_RENDERER:"KonvaContentSharingRenderer"}}(),AvayaClientServices.Base.Library.Service.jQuery.addOnVersionChangedCallback(function(t){C=t})}();