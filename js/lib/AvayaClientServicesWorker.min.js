self.AvayaClientServicesWorker={},function(e){"use strict";function t(){}t.prototype={compareBlocks:function(e,t,r,n,a,o){for(var i=[],s=t.length,c=0;c<s;c++){e[c]=e[c]||[];for(var _=t[c].length,h=0;h<_;h++)this._compareBlock(e,t[c][h],i,h,c,r,n,a,o)}return i},_compareBlock:function(e,t,r,n,a,o,i,s,c){for(var _="",h=t.data.length,l=0;l<h;l++)_+=btoa(t.data[l]);var u=e[a][n];if(!u||_!==u.base64){var g={_width:t.width,_height:t.data.length,_x:a*o,_y:n*i,_row:n,_column:a,_blocks:[],_data:t.data};g._type=this._determineType(g._data,s,c),r.push(g),e[a][n]={base64:_}}},_determineType:function(e,t,r){for(var n,a,o,i={},s=0,c=e.length,_=0;_<c;_++)for(o=(n=r(e[_])).length,a=0;a<o;a++){var h=""+(16777215&n[a]);if(i[h]||(i[h]=0,s++),t<s)return 0;i[h]++}return 1}},e.BlocksComparator=t}(self.AvayaClientServicesWorker),function(e){"use strict";function t(){}t.prototype={generateBlocks:function(e,t,r,n,a){for(var o=[],i=r.length,s=4*n,c=4*e,_=0,h=0;_<i;_+=s,h++)for(var l=Math.floor(h/t),u=0;u<s;u+=c){var g=c;s<u+g&&(g=s-u);var f=Math.floor(u/c);o[f]||(o[f]=[]);var p=o[f][l]||{data:[],width:g/4};p.data=a(p,r.slice(_+u,_+u+g)),o[f][l]=p}return o}},e.BlocksGenerator=t}(self.AvayaClientServicesWorker),function(e){"use strict";function t(){}t.prototype={mergeBlocks:function(e,t){return e=this._sortByRow(e),e=this._mergeByRow(e,t),e=this._sortByColumn(e),(e=this._mergeByColumn(e)).map(this._createMergedBlock)},_sortByColumn:function(e){return e.sort(function(e,t){return e._column===t._column?e._row-t._row:e._column-t._column})},_sortByRow:function(e){return e.sort(function(e,t){return e._row===t._row?e._column-t._column:e._row-t._row})},_compareBlocksByColumn:function(e,t){return e._x===t._x&&e._type===t._type&&e._width===t._width&&(e._y+e._height===t._y||t._y+t._height===e._y)},_compareBlocksByRow:function(e,t){return e._y===t._y&&e._type===t._type&&e._height===t._height&&(e._x+e._width===t._x||t._x+t._width===e._x)},_merge:function(e,t,r){for(var n=[],a=this._copyBlock(e[0]),o=1;o<e.length;o++)t(a,e[o])?(0<e[o]._blocks.length?this._copyBlocks(e,o,a):a._blocks.push(e[o]),r(a,e[o])):(n.push(a),a=this._copyBlock(e[o]));return n.push(a),n},_mergeByColumn:function(e){return this._merge(e,this._compareBlocksByColumn,function(e,t){e._height+=t._height,e._data=e._data.concat(t._data)})},_mergeByRow:function(e,r){return this._merge(e,this._compareBlocksByRow,function(e,t){r(e,t),e._width+=t._width})},_copyBlocks:function(e,t,r){e[t]._blocks.forEach(function(e){r._blocks.push(e)})},_copyBlock:function(e){var t;return 0===e._blocks.length?(t={_x:e._x,_y:e._y,_row:e._row,_column:e._column,_width:e._width,_height:e._height,_type:e._type,_blocks:[],_data:e._data})._blocks.push(e):t=e,t},_createMergedBlock:function(e){var t=e._data.reduce(function(e,t){return Array.prototype.push.apply(e,t),e},[]),r=new ImageData(new Uint8ClampedArray(t),e._width,e._height);return{_x:e._x,_y:e._y,_row:e._row,_column:e._column,_width:e._width,_height:e._height,_type:e._type,_imgData:r}}},e.BlocksMerger=t}(self.AvayaClientServicesWorker),function(S){"use strict";function e(e,t,r){this._blocksGenerator=e,this._blocksComparator=t,this._blocksMerger=r,this._config=void 0,this._generatingKeyFrame=!0,this._previousWidth=-1,this._previousHeight=-1,this._generatedFrames=0,this._previousScreen=void 0}e.prototype={setKeyFrameGeneration:function(e){this._generatingKeyFrame=e},generateChangedBlocks:function(e,t,r,n){var a={};this._config=t,this._determineKeyFrameGeneration(r,n);var o=Date.now();a.prepareScreenTime=Date.now()-o,this._generatingKeyFrame?(this._previousScreen=[],this._generatingKeyFrame=!1,a.isKeyFrame=!0):a.isKeyFrame=!1,o=Date.now();var i=[],s={},c=new Uint32Array(e.buffer);if(this._previousScreen&&0<this._previousScreen.length)for(var _=0;_<c.length;_++)if(this._previousScreen[_]!==c[_]){var h=~~(_/r),l=~~(h/this._config.blockSize),u=~~((_-h*r)/this._config.blockSize);s[u]=s[u]||[],s[u].includes(l)||(s[u][s[u].length]=l),_+=this._config.blockSize-_%this._config.blockSize}return this._previousScreen&&0<this._previousScreen.length&&0===Object.keys(s).length||(this._previousScreen=c,i=this._quickDetermineChangedBlocks(s,e,r)),a.determineChangedBlocksTime=Date.now()-o,0<i.length&&(o=Date.now(),i=this._blocksMerger.mergeBlocks(i,this._mergeByRow.bind(this)),a.mergeBlocksTime=Date.now()-o,this._generatedFrames++),{changedBlocks:i,meta:a}},_determineKeyFrameGeneration:function(e,t){this._generatedFrames===this._config.framesPerKeyFrame&&(this._generatingKeyFrame=!0,this._generatedFrames=0),e===this._previousWidth&&t===this._previousHeight||(this._previousWidth=e,this._previousHeight=t,this._generatingKeyFrame=!0)},_quickDetermineChangedBlocks:function(e,_,t){var y=[],h=_.length,l=4*t,u=4*this._config.blockSize,r=function(e,t,r){var n,a,o,i,s,c,_={_width:r.width,_height:r.data.length,_x:e*this._config.blockSize,_y:t*this._config.blockSize,_row:t,_column:e,_blocks:[],_data:r.data,_type:S.ScreenSharingImageTypes.PNG},h={},l=0,u=!1,g=0,f=!1,p=!1;for(s=0;s<_._data.length&&!u;s+=2){var d=this._prepareBuffer(_._data[s]);for(c=0;c<d.length&&!u;c++)if(i=16777215&d[c],l<=this._config.losslessColorLimit&&!h[i]&&(h[i]=!0,l++),a=i>>8&255,o=i>>16&255,(65<(n=255&i)&&a<35||180<n&&a<55)&&(f=!0),(n<130&&a<130&&o<130||180<o)&&(p=!0),p&&f&&(g++,p=f=!1),l>=this._config.losslessColorLimit&&(_._type=S.ScreenSharingImageTypes.JPEG),16<g){_._type=S.ScreenSharingImageTypes.JPEG_RED_WITH_BLACK,u=!0;break}}y.push(_)}.bind(this);if(0!==Object.keys(e).length){var n=function(e,t){for(var r={data:[],width:0},n=t,a=n*this._config.blockSize,o=a*l;n===t&&o<h;o+=l,n=~~(++a/this._config.blockSize))for(var i=e,s=i*u;i===e&&s<l;i=~~((s+=u)/u)){var c=u;l<s+c&&(c=l-s),r.width=c/4,r.data=this._prepareBlockData(r,_.slice(o+s,o+s+c))}return r}.bind(this);for(var a in e)if(e.hasOwnProperty(a))for(var o=0;o<e[a].length;o++){var i=n(parseInt(a),e[a][o]);r(a,e[a][o],i)}}else{for(var s=[],c=0,g=0;c<h;c+=l,g++)for(var f=~~(g/this._config.blockSize),p=0;p<l;p+=u){var d=u;l<p+d&&(d=l-p);var m=~~(p/u);s[m]||(s[m]=[]);var k=s[m][f]||{data:[],width:d/4};k.data=this._prepareBlockData(k,_.slice(c+p,c+p+d)),s[m][f]=k}for(var v=0;v<s.length;v++)for(var w=s[v].length,B=0;B<w;B++)r(v,B,s[v][B])}return y},_prepareScreen:function(e){return e},_prepareBlockData:function(e,t){return e.data=e.data.concat(t),e.data},_prepareBuffer:function(e){return new Uint32Array(e.buffer)},_mergeByRow:function(e,t){for(var r=Math.ceil(e._width/this._config.blockSize),n=0;n<t._data.length;n++)Array.prototype.splice.apply(e._data,[r+(r+1)*n,0].concat(t._data[n]))}},S.DataManipulator=e}(self.AvayaClientServicesWorker),function(e){"use strict";self.AvayaClientServicesWorker.ScreenCapturerWorkerEvents={INITIALIZE:"initialize",CHANGED_BLOCKS:"changedBlocksMessage",SEND_IMAGE_DATA:"wholeImgData",WORKER_STARTED:"workerStarted"}}(),function(e){"use strict";self.AvayaClientServicesWorker.ScreenSharingImageTypes={JPEG:0,PNG:1,JPEG_RED_WITH_BLACK:2}}(),function(c){"use strict";var _,h;self.onmessage=function(e){if(e.data.type===c.ScreenCapturerWorkerEvents.INITIALIZE){var t=new c.BlocksGenerator,r=new c.BlocksComparator,n=new c.BlocksMerger;_=new c.DataManipulator(t,r,n),h=e.data.config,self.postMessage({type:c.ScreenCapturerWorkerEvents.WORKER_STARTED})}else if(e.data.type===c.ScreenCapturerWorkerEvents.SEND_IMAGE_DATA){var a=Date.now();e.data.forceKeyFrame&&_.setKeyFrameGeneration(!0);var o=_.generateChangedBlocks(e.data.imgData,h,e.data.width,e.data.height),i=o.changedBlocks.map(function(e){return e._imgData.data.buffer}),s={processingTime:Date.now()-a,processedBlocks:o.changedBlocks.length,keyFrame:o.meta.isKeyFrame,meta:o.meta,generatedPNGs:o.changedBlocks.reduce(function(e,t){return t._type===c.ScreenSharingImageTypes.PNG&&e++,e},0)};self.postMessage({type:c.ScreenCapturerWorkerEvents.CHANGED_BLOCKS,data:o.changedBlocks,meta:s},i)}}}(self.AvayaClientServicesWorker);